"0","library(tidyverse)"
"0","library(bigrquery)"
"0",""
"0","# This query represents dataset ""followup_cohort_data"" for domain ""person"" and was generated for All of Us Controlled Tier Dataset v7"
"0","dataset_48995884_person_sql <- paste("""
"0","    SELECT"
"0","        person.person_id,"
"0","        p_gender_concept.concept_name as gender,"
"0","        person.birth_datetime as date_of_birth,"
"0","        p_race_concept.concept_name as race,"
"0","        p_ethnicity_concept.concept_name as ethnicity,"
"0","        p_sex_at_birth_concept.concept_name as sex_at_birth"
"0","    FROM"
"0","        `person` person"
"0","    LEFT JOIN"
"0","        `concept` p_gender_concept"
"0","            ON person.gender_concept_id = p_gender_concept.concept_id"
"0","    LEFT JOIN"
"0","        `concept` p_race_concept"
"0","            ON person.race_concept_id = p_race_concept.concept_id"
"0","    LEFT JOIN"
"0","        `concept` p_ethnicity_concept"
"0","            ON person.ethnicity_concept_id = p_ethnicity_concept.concept_id"
"0","    LEFT JOIN"
"0","        `concept` p_sex_at_birth_concept"
"0","            ON person.sex_at_birth_concept_id = p_sex_at_birth_concept.concept_id"
"0","    WHERE"
"0","        person.PERSON_ID IN (SELECT"
"0","            distinct person_id"
"0","        FROM"
"0","            `cb_search_person` cb_search_person"
"0","        WHERE"
"0","            cb_search_person.person_id IN (SELECT"
"0","                person_id"
"0","            FROM"
"0","                `person` p"
"0","            WHERE"
"0","                race_concept_id IN (8527, 8516, 2100000001, 8515, 903096, 2000000008, 45882607, 1177221, 38003615, 8557) )"
"0","            AND cb_search_person.person_id IN (SELECT"
"0","                criteria.person_id"
"0","            FROM"
"0","                (SELECT"
"0","                    DISTINCT person_id, entry_date, concept_id"
"0","                FROM"
"0","                    `cb_search_all_events`"
"0","                WHERE"
"0","                    (concept_id IN (1585857)"
"0","                    AND is_standard = 0"
"0","                    AND  value_source_concept_id IN (1585858)"
"0","                    OR  concept_id IN (1585857)"
"0","                    AND is_standard = 0"
"0","                    AND  value_source_concept_id IN (1585859))) criteria )"
"0","            AND cb_search_person.person_id NOT IN (SELECT"
"0","                criteria.person_id"
"0","            FROM"
"0","                (SELECT"
"0","                    DISTINCT person_id, entry_date, concept_id"
"0","                FROM"
"0","                    `cb_search_all_events`"
"0","                WHERE"
"0","                    (concept_id IN(SELECT"
"0","                        DISTINCT c.concept_id"
"0","                    FROM"
"0","                        `cb_criteria` c"
"0","                    JOIN"
"0","                        (SELECT"
"0","                            CAST(cr.id as string) AS id"
"0","                        FROM"
"0","                            `cb_criteria` cr"
"0","                        WHERE"
"0","                            concept_id IN (440508)"
"0","                            AND full_text LIKE '%_rank1]%'      ) a"
"0","                            ON (c.path LIKE CONCAT('%.', a.id, '.%')"
"0","                            OR c.path LIKE CONCAT('%.', a.id)"
"0","                            OR c.path LIKE CONCAT(a.id, '.%')"
"0","                            OR c.path = a.id)"
"0","                    WHERE"
"0","                        is_standard = 1"
"0","                        AND is_selectable = 1)"
"0","                    AND is_standard = 1 )) criteria )"
"0","            AND cb_search_person.person_id NOT IN (SELECT"
"0","                person_id"
"0","            FROM"
"0","                `person` p"
"0","            WHERE"
"0","                race_concept_id IN (2100000001, 903096, 2000000008, 45882607, 1177221, 38003615, 8557) ) )"", sep="""")"
"0",""
"0","# Formulate a Cloud Storage destination path for the data exported from BigQuery."
"0","# NOTE: By default data exported multiple times on the same day will overwrite older copies."
"0","#       But data exported on a different days will write to a new location so that historical"
"0","#       copies can be kept as the dataset definition is changed."
"0","person_48995884_path <- file.path("
"0","  Sys.getenv(""WORKSPACE_BUCKET""),"
"0","  ""bq_exports"","
"0","  Sys.getenv(""OWNER_EMAIL""),"
"0","  strftime(lubridate::now(), ""%Y%m%d""),  # Comment out this line if you want the export to always overwrite."
"0","  ""person_48995884"","
"0","  ""person_48995884_*.csv"")"
"0","message(str_glue('The data will be written to {person_48995884_path}. Use this path when reading ',"
"0","                 'the data into your notebooks in the future.'))"
"2","The data will be written to /bq_exports//20241031/person_48995884/person_48995884_*.csv. Use this path when reading the data into your notebooks in the future.
"
"0","# Perform the query and export the dataset to Cloud Storage as CSV files."
"0","# NOTE: You only need to run `bq_table_save` once. After that, you can"
"0","#       just read data from the CSVs in Cloud Storage."
"0","bq_table_save("
"0","  bq_dataset_query(Sys.getenv(""WORKSPACE_CDR""), dataset_48995884_person_sql, billing = Sys.getenv(""GOOGLE_PROJECT"")),"
"0","  person_48995884_path,"
"0","  destination_format = ""CSV"")"
"1","[1m[33mError[39m in `bq_dataset_query()`:[22m
[38;5;232m[33m![38;5;232m When `x` is a string, it must contain 2 components separted by ""."".[39m
Backtrace:
[90m 1. [39m[1mbigrquery[22m::bq_table_save(...)
[90m 3. [39m[1m[94mbigrquery::bq_dataset_query([39m[22mSys.getenv(""WORKSPACE_CDR""), dataset_48995884_person_sql, billing = Sys.getenv(""GOOGLE_PROJECT"")[1m[94m)[39m[22m
"
